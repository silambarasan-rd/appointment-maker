<div class="appointment-form-container">
  <div class="form-header">
    <h2>{{ isEditMode ? 'Edit Appointment' : 'Create Appointment' }}</h2>
  </div>

  <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
    <div class="row">
      <!-- Title Field -->
      <div class="col-md-12">
        <div class="form-group">
          <label for="title" class="form-label">
            Title <span class="required">*</span>
          </label>
          <input
            id="title"
            type="text"
            class="form-control"
            formControlName="title"
            placeholder="Ex: Meeting with Vijay"
            [class.is-invalid]="appointmentForm.get('title')?.invalid && appointmentForm.get('title')?.touched"
          />
          <div class="invalid-feedback" *ngIf="appointmentForm.get('title')?.invalid && appointmentForm.get('title')?.touched">
            Title is required and must be at least 3 characters.
          </div>
        </div>
      </div>
    </div>

    <!-- Notes Field -->
    <div class="row">
      <div class="col-12">
        <div class="form-group">
          <label for="notes" class="form-label">
            Notes
          </label>
          <textarea
            id="notes"
            class="form-control"
            formControlName="notes"
            placeholder="Ex: Discuss about the project requirements and the timeline."
            rows="3"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Date Range & Time -->
    <div class="row">
      <div class="col-md-12">
        <div class="form-group">
          <label for="dateRange" class="form-label">
            Date Range <span class="required">*</span>
          </label>
          <input
            type="text"
            id="dateRange"
            class="form-control"
            formControlName="dateRange"
            ngxDaterangepickerBootstrap
            [locale]="dateRangeLocale"
            [minDate]="minDate"
            [maxDate]="null"
            [timePicker]="true"
            [timePickerIncrement]="5"
            [alwaysShowCalendars]="true"
            startKey="start"
            endKey="end"
            [(ngModel)]="selectedDateRange"
            (change)="onDateRangeChange($event)"
            placeholder="Select date range"
            [class.is-invalid]="appointmentForm.get('dateRange')?.invalid && appointmentForm.get('dateRange')?.touched"
          />
          <div class="invalid-feedback" *ngIf="appointmentForm.get('dateRange')?.invalid && appointmentForm.get('dateRange')?.touched">
            Please select a date range.
          </div>
        </div>
      </div>
    </div>

    <!-- Conflicting Appointments -->
     @if (selectedDateRange && conflictingAppointments && conflictingAppointments.length > 0) {
      <div class="row">
        <div class="col-md-12">
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
              <fa-icon [icon]="faWarning" class="me-2"></fa-icon>
              <strong>Conflicting Appointments Found</strong>
            </div>
            <div class="mt-2">
              <small>The following appointments conflict with your selected time slot:</small>
            </div>
            <div class="mt-2">
              <div *ngFor="let conflict of conflictingAppointments" class="conflict-item mb-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <strong>{{ conflict.title }}</strong>
                    <div class="small text-muted">
                      {{ conflict.start_time | date: 'dd/MM/yyyy hh:mma' }} - {{ conflict.end_time | date: 'hh:mma' }}
                    </div>
                    @if (conflict.participants && conflict.participants.length > 0) {
                      <div class="small">
                        Participants: {{ formatParticipants(conflict) }}
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
     }



    <!-- Participants Section -->
    <div class="row">
      <div class="col-12">
        <div class="form-group">
          <label class="form-label">
            Participants <span class="required">*</span>
          </label>

          <!-- Participant Input -->
          <div class="input-group mb-2">
            <input
              type="text"
              class="form-control"
              [(ngModel)]="participantInput"
              [ngModelOptions]="{ standalone: true }"
              placeholder="Type participant name and press Add"
            />
            <button
              type="button"
              class="btn btn-outline-primary"
              (click)="addParticipant()"
            >
              <fa-icon [icon]="faPlus"></fa-icon>
            </button>
          </div>

          <!-- Selected Participants -->
          <div class="selected-participants mb-3" *ngIf="selectedParticipants.length > 0">
            <div class="participant-badge" *ngFor="let participant of selectedParticipants">
              {{ participant.full_name }}
              <button
                type="button"
                class="btn-close"
                (click)="removeParticipant(participant.id)"
                title="Remove participant"
              ></button>
            </div>
          </div>

          <!-- Available Participants -->
          <div class="available-participants" *ngIf="getAvailableParticipants().length > 0">
            <small class="text-muted d-block mb-2">Or select from available:</small>
            <div class="participant-options">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                *ngFor="let participant of getAvailableParticipants()"
                (click)="selectParticipant(participant)"
              >
                + {{ participant.full_name }}
              </button>
            </div>
          </div>

          <!-- Validation Error -->
          <div class="invalid-feedback d-block" *ngIf="selectedParticipants.length === 0">
            At least one participant is required.
          </div>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="row form-actions">
      <div class="col-12">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="appointmentForm.invalid || selectedParticipants.length === 0"
        >
          <fa-icon [icon]="faSave"></fa-icon> {{ isEditMode ? 'Update' : 'Create' }} Appointment
        </button>
        <button type="button" class="btn btn-secondary" (click)="onCancel()">
          <fa-icon [icon]="faTimes"></fa-icon> Cancel
        </button>
      </div>
    </div>
  </form>
</div>
